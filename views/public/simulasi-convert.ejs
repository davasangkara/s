<%- include('../partials/header') %>

<section class="relative overflow-hidden">
  <div class="absolute inset-0 bg-gradient-to-b from-[#F5F8FF] via-white to-[#FFF6FB]"></div>

  <div class="relative container mx-auto max-w-4xl px-6 py-10">
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-slate-900">
        Simulasi Convert Pulsa
      </h1>
      <p class="text-slate-600 mt-1">Pilih operator & masukkan nominal pulsa. Hasil dana diterima mengikuti rate admin.</p>
    </div>

    <div class="grid md:grid-cols-2 gap-6 items-start">
      <!-- FORM -->
      <form id="formPulsa" class="bg-white rounded-2xl shadow p-6 space-y-5">
        <div>
          <label class="block text-sm font-semibold text-slate-800 mb-1">Provider</label>
          <select id="provider" class="w-full border rounded-xl px-3 py-2 focus:ring focus:outline-none">
            <% if ((rates||[]).length === 0) { %>
              <option disabled>(Belum ada data rate)</option>
            <% } else { %>
              <% rates.forEach((r, i) => { %>
                <option value="<%= i %>"><%= r.provider %> — <%= Number(r.rate_pct||0).toFixed(2) %>%</option>
              <% }) %>
            <% } %>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-slate-800 mb-1">Nominal Pulsa (Rp)</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-semibold">Rp</span>
            <input id="amount" type="text" inputmode="numeric" class="w-full border rounded-xl pl-10 pr-3 py-2 focus:ring focus:outline-none" placeholder="cth: 500.000">
          </div>
          <p class="text-xs text-slate-500 mt-1">Rate = % diterima. Contoh: 80% → menerima 80% dari nominal.</p>
        </div>

        <button type="button" id="btnHitung" class="w-full md:w-auto px-5 py-2.5 rounded-xl bg-blue-600 text-white hover:bg-blue-700 shadow">
          Hitung
        </button>
      </form>

      <!-- HASIL -->
      <div class="bg-white rounded-2xl shadow p-6">
        <h3 class="text-lg font-semibold text-slate-900">Hasil</h3>
        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl bg-slate-50 border">
            <div class="text-xs text-slate-500">Provider</div>
            <div class="text-base font-semibold" id="outProv">-</div>
          </div>
          <div class="p-4 rounded-xl bg-slate-50 border">
            <div class="text-xs text-slate-500">Rate Diterima</div>
            <div class="text-base font-semibold" id="outRate">0%</div>
          </div>
          <div class="p-4 rounded-xl bg-slate-50 border">
            <div class="text-xs text-slate-500">Nominal Pulsa</div>
            <div class="text-base font-semibold" id="outAmount">Rp 0</div>
          </div>
          <div class="sm:col-span-2 p-4 rounded-xl border bg-emerald-50">
            <div class="text-xs text-emerald-700">Dana Diterima</div>
            <div class="text-2xl font-extrabold text-emerald-700" id="outNet">Rp 0</div>
          </div>
        </div>

        <a id="waBtn" target="_blank"
           class="mt-5 inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">
          Ajukan via WhatsApp
        </a>
      </div>
    </div>
  </div>
</section>

<%- include('../partials/footer') %>

<script>
(function(){
  const RATES = <%- JSON.stringify(rates||[]) %>;
  const nf = new Intl.NumberFormat('id-ID');
  const toRp = n => 'Rp ' + nf.format(Math.max(0, Math.round(n||0)));
  const parseNum = v => Number(String(v||'').replace(/[^\d]/g,'')) || 0;

  const sel = document.getElementById('provider');
  const amount = document.getElementById('amount');
  const btn = document.getElementById('btnHitung');
  const outProv = document.getElementById('outProv');
  const outRate = document.getElementById('outRate');
  const outAmount = document.getElementById('outAmount');
  const outNet = document.getElementById('outNet');
  const waBtn = document.getElementById('waBtn');

  amount.addEventListener('input', () => {
    amount.value = nf.format(parseNum(amount.value));
  });

  function current(){
    const idx = Number(sel.value) || 0;
    return RATES[idx] || null;
  }

  function hitung(){
    const r = current();
    if(!r) return;

    const nominal = parseNum(amount.value);
    const rate = Number(r.rate_pct || 0);
    const net = nominal * (rate/100);

    outProv.textContent = r.provider;
    outRate.textContent = rate.toFixed(2) + '%';
    outAmount.textContent = toRp(nominal);
    outNet.textContent = toRp(net);

    const text = `Halo admin, saya ingin convert pulsa:
• Provider: ${r.provider}
• Nominal: ${toRp(nominal)}
• Rate diterima: ${rate.toFixed(2)}%
• Dana diterima (estimasi): ${toRp(net)}

Mohon bantuannya. Terima kasih.`;
    waBtn.href = 'https://wa.me/6285785114471?text=' + encodeURIComponent(text);
  }

  btn.addEventListener('click', hitung);
  if ((RATES||[]).length) hitung(); // auto-preview
})();
</script>
