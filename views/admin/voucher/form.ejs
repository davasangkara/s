<%- include('../../partials/admin-header', { title }) %>

<style>
  #discSlider{
    -webkit-appearance:none;height:10px;border-radius:9999px;width:100%;
    background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#10b981 100%);
  }
  #discSlider::-webkit-slider-thumb{ -webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid #6366f1;box-shadow:0 2px 10px rgba(99,102,241,.35) }
  #discSlider::-moz-range-thumb{ width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid #6366f1 }
  #gauge{ background: conic-gradient(hsl(var(--tone)) 0deg 0deg, #e5e7eb 0deg 360deg); }
</style>

<div class="max-w-2xl mx-auto mt-8">
  <div class="mb-5 flex items-center gap-3">
    <a href="/admin/voucher" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m15 19-7-7 7-7"/></svg>
      Kembali
    </a>
    <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight"><%= item ? 'Edit Voucher' : 'Tambah Voucher' %></h1>
  </div>

  <form id="vForm" method="POST" action="<%= item ? '/admin/voucher/edit/'+item.id : '/admin/voucher/new' %>" class="bg-white rounded-2xl shadow ring-1 ring-black/5 p-6 space-y-6">
    <div class="grid sm:grid-cols-5 gap-6">
      <div class="sm:col-span-3 space-y-5">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Tipe</label>
          <select id="typeSel" name="type" required class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none">
            <option value="">— Pilih Tipe —</option>
            <option value="FNB"  <%= item?.type==='FNB' ? 'selected':'' %>>F&B</option>
            <option value="GAME" <%= item?.type==='GAME' ? 'selected':'' %>>Game</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Brand</label>
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16M4 17h16"/></svg>
            <input id="brand" name="brand" required value="<%= item?.brand || '' %>" class="w-full border rounded-xl pl-9 pr-3 py-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none" placeholder="Starbucks / Steam / …">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Rate (%)</label>
          <div class="relative">
            <input id="disc" type="number" step="0.01" min="0" max="100" name="discount_pct" required value="<%= item?.discount_pct ?? '' %>" class="w-full border rounded-xl pl-3 pr-12 py-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none" placeholder="cth: 8">
            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 font-semibold">%</span>
          </div>
          <input id="discSlider" type="range" min="0" max="25" step="0.1" class="w-full mt-3">
          <p class="text-xs text-slate-500 mt-1">8 berarti bayar 92% dari nominal. (Slider difokuskan hingga 25% utk kontrol halus)</p>
        </div>
      </div>

      <!-- Gauge -->
      <div class="sm:col-span-2">
        <div class="rounded-2xl border bg-slate-50 p-5 h-full grid place-items-center">
          <div class="relative" id="gWrap" style="--tone: 0 85% 45%">
            <div id="gauge" class="w-44 h-44 rounded-full"></div>
            <div class="absolute inset-3 rounded-full grid place-items-center text-center bg-white">
              <div>
                <div class="text-xs text-slate-500">Rate</div>
                <div id="gVal" class="text-3xl font-extrabold text-slate-900">0.00%</div>
                <div id="gHint" class="text-[11px] text-slate-500 mt-1">Kecil</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Simulasi cepat -->
    <div class="rounded-xl border bg-slate-50 p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs text-slate-500">Simulasi cepat</div>
          <div class="text-sm text-slate-700">Nominal contoh: <span id="sNom" class="font-semibold">Rp 100.000</span></div>
        </div>
        <div class="flex items-center gap-2">
          <button type="button" data-n="100000" class="sBtn px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">100k</button>
          <button type="button" data-n="250000" class="sBtn px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">250k</button>
          <button type="button" data-n="500000" class="sBtn px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">500k</button>
        </div>
      </div>
      <div class="mt-3 grid sm:grid-cols-3 gap-3">
        <div class="p-3 rounded-lg bg-white border">
          <div class="text-xs text-slate-500">Bayar</div>
          <div id="sBayar" class="font-semibold text-emerald-700">Rp 0</div>
        </div>
        <div class="p-3 rounded-lg bg-white border">
          <div class="text-xs text-slate-500">Rata</div>
          <div id="sDiscRp" class="font-semibold text-rose-600">Rp 0</div>
        </div>
        <div class="p-3 rounded-lg bg-white border">
          <div class="text-xs text-slate-500">Rate (%)</div>
          <div id="sDiscPct" class="font-semibold text-slate-800">0%</div>
        </div>
      </div>
    </div>

    <div class="pt-2 flex gap-2">
      <button id="saveBtn" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-indigo-600 to-fuchsia-600 text-white hover:brightness-110 disabled:opacity-50 disabled:pointer-events-none">Simpan</button>
      <a href="/admin/voucher" class="px-5 py-2.5 rounded-xl bg-white border hover:bg-slate-50">Batal</a>
    </div>
  </form>
</div>

<script>
(function(){
  const nf = new Intl.NumberFormat('id-ID');
  const toRp = n => 'Rp ' + nf.format(Math.max(0, Math.round(n||0)));

  const brand = document.getElementById('brand');
  const disc  = document.getElementById('disc');
  const slider= document.getElementById('discSlider');
  const typeSel = document.getElementById('typeSel');
  const saveBtn = document.getElementById('saveBtn');

  const wrap = document.getElementById('gWrap');
  const gRing= document.getElementById('gauge');
  const gVal = document.getElementById('gVal');
  const gHint= document.getElementById('gHint');

  let nominal = 100000;
  const sNom = document.getElementById('sNom');
  const sBay = document.getElementById('sBayar');
  const sDRp = document.getElementById('sDiscRp');
  const sDPc = document.getElementById('sDiscPct');

  function hueFromDisc(d){ // 0%→red, 25%→green
    const v = Math.max(0, Math.min(25, d));
    return 0 + (140 * (v/25));
  }
  function setGauge(p){
    const deg = Math.min(100, Math.max(0, p))/100*360;
    const hue = hueFromDisc(p).toFixed(0);
    wrap.style.setProperty('--tone', `${hue} 85% 45%`);
    gRing.style.background = `conic-gradient(hsl(${hue} 85% 45%) 0deg ${deg}deg, #e5e7eb ${deg}deg 360deg)`;
    gVal.textContent = (isFinite(p)? p.toFixed(2):'0.00') + '%';
    gHint.textContent = p > 15 ? 'Besar' : p >= 5 ? 'Sedang' : 'Kecil';
  }
  function refresh(){
    const d = Number(disc.value||0);
    const bayar = nominal * (1 - d/100);
    const pot   = nominal - bayar;
    sNom.textContent = toRp(nominal);
    sBay.textContent = toRp(bayar);
    sDRp.textContent = toRp(pot);
    sDPc.textContent = (isFinite(d)? d.toFixed(2):'0.00') + '%';
    setGauge(d); validate();
  }
  function syncFromInput(){
    let v = parseFloat(disc.value);
    if(!isFinite(v)) v = 0;
    slider.value = Math.max(slider.min, Math.min(slider.max, v));
    refresh();
  }
  function syncFromSlider(){
    disc.value = parseFloat(slider.value).toFixed(2);
    refresh();
  }
  function validate(){
    saveBtn.disabled = !((brand.value||'').trim().length && (typeSel.value||'') && isFinite(parseFloat(disc.value)));
  }
  document.querySelectorAll('.sBtn').forEach(b=>b.addEventListener('click',()=>{ nominal = Number(b.dataset.n||nominal); refresh(); }));
  brand.addEventListener('input', validate);
  typeSel.addEventListener('change', validate);
  disc.addEventListener('input', syncFromInput);
  slider.addEventListener('input', syncFromSlider);

  if(disc.value===''){ disc.value='8.00'; slider.value='8'; }
  syncFromInput(); validate();
})();
</script>

<%- include('../../partials/admin-footer') %>
