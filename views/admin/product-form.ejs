<%- include('../partials/admin-header') %>

<%
  // Fallback aman kalau 'action' tidak dikirim dari route
  const formAction = (typeof action !== 'undefined' && action)
    ? action
    : (product && product.id ? `/admin/produk/edit/${product.id}` : '/admin/produk/edit/0');
  const isEdit = !!(product && product.id);
%>

<style>
  :root{
    --line:#e5e7eb;
    --shadow:0 12px 36px rgba(2,6,23,.06);
    --primary:#2563eb;
  }
  .soft-card{background:#fff;border-radius:1.25rem;box-shadow:var(--shadow);border:1px solid var(--line)}
  .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.75rem;padding:.6rem 1rem;transition:.2s}
  .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:#1d4ed8}
  .btn-ghost{background:#fff;border:1px solid var(--line)}.btn-ghost:hover{background:#f9fafb}
  .field{display:block}
  .label{display:flex;align-items:center;gap:.5rem;font-size:.9rem;font-weight:600;color:#334155;margin-bottom:.35rem}
  .hint{font-size:.8rem;color:#64748b;margin-top:.35rem}
  .input-wrap{position:relative}
  .ipt{width:100%;border:1px solid var(--line);border-radius:.75rem;padding:.65rem .9rem;outline:0}
  .ipt:focus{box-shadow:0 0 0 3px rgba(37,99,235,.15);border-color:#bfdbfe}
  .prefix,.suffix{position:absolute;top:50%;transform:translateY(-50%);color:#64748b;font-size:.9rem}
  .prefix{left:.8rem}.suffix{right:.8rem}
  .ipt.has-prefix{padding-left:2.1rem}
  .ipt.has-suffix{padding-right:2.1rem}
  /* switch */
  .switch{position:relative;display:inline-flex;width:48px;height:28px;background:#e2e8f0;border-radius:999px;transition:.2s;border:1px solid var(--line)}
  .switch i{position:absolute;top:50%;left:4px;transform:translateY(-50%);width:22px;height:22px;background:#fff;border-radius:999px;transition:.2s;box-shadow:0 2px 6px rgba(0,0,0,.12)}
  .switch.on{background:#dbeafe;border-color:#bfdbfe}
  .switch.on i{left:22px;background:#fff}
  .badge{display:inline-flex;align-items:center;gap:.4rem;font-weight:700;font-size:.72rem;padding:.25rem .55rem;border-radius:.5rem}
</style>

<!-- HERO MINI -->
<section class="rounded-3xl p-6 md:p-8 mb-8 relative overflow-hidden" style="background:
  radial-gradient(900px 320px at -10% -10%, rgba(255,255,255,.25), transparent),
  radial-gradient(900px 320px at 110% 120%, rgba(255,255,255,.18), transparent),
  linear-gradient(135deg, #2563EB 0%, #4F46E5 55%, #DB2777 100%);">
  <div class="absolute -right-20 -top-24 w-[420px] h-[420px] rounded-full bg-white/10 blur-3xl"></div>
  <div class="relative z-10 flex items-center justify-between gap-6 text-white">
    <div>
      <p class="text-white/90 text-sm mb-1">Kelola detail & status produk</p>
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">
        <%= isEdit ? 'Edit Produk' : 'Tambah Produk' %>
      </h1>
    </div>
    <span class="badge <%= isEdit ? 'bg-white/10 border border-white/60' : 'bg-white text-blue-700' %>">
      <svg class="w-4 h-4 <%= isEdit ? 'text-white' : 'text-blue-700' %>" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="<%= isEdit ? 'M11 5h2m-1 14v-4m5.5-8.5L20 7l-9 9-4 1 1-4 9-9z' : 'M12 5v14M5 12h14' %>"/>
      </svg>
      <%= isEdit ? 'Mode Edit' : 'Mode Tambah' %>
    </span>
  </div>
</section>

<div class="max-w-5xl mx-auto">
  <form action="<%= formAction %>" method="POST" class="soft-card p-6 md:p-8 space-y-7">
    <!-- Row 1 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="field">
        <label class="label">Nama Produk</label>
        <input type="text" name="name" required
               value="<%= product ? product.name : '' %>"
               class="ipt" placeholder="Contoh: Pulsa Telkomsel 50k">
        <p class="hint">Nama akan muncul di daftar & pencarian.</p>
      </div>

      <div class="field">
        <label class="label">Kategori</label>
        <select name="category_id" required class="ipt">
          <option value="">— Pilih Kategori —</option>
          <% (categories||[]).forEach(c => { %>
            <option value="<%= c.id %>" <%= product && product.category_id===c.id ? 'selected' : '' %>><%= c.name %></option>
          <% }) %>
        </select>
        <p class="hint">Butuh kategori baru? <a href="/admin/kategori" class="text-blue-600 underline">Kelola kategori</a>.</p>
      </div>
    </div>

    <!-- Row 2 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="field">
        <label class="label">Harga (IDR)</label>
        <div class="input-wrap">
          <span class="prefix">Rp</span>
          <input id="priceInput" type="number" name="price" min="0" step="1" required
                 value="<%= product ? product.price : '' %>"
                 class="ipt has-prefix" placeholder="0">
        </div>
        <p class="hint">Preview: <span id="pricePretty" class="font-semibold text-slate-800">Rp0</span></p>
      </div>

      <div class="field">
        <label class="label">Rate</label>
        <div class="input-wrap">
          <input id="rateInput" type="number" name="rate" min="0" step="0.01" required
                 value="<%= product ? product.rate : '' %>"
                 class="ipt has-suffix" placeholder="0.00">
          <span class="suffix">%</span>
        </div>
        <p class="hint">Contoh 95 berarti 95%.</p>
      </div>

      <div class="field">
        <label class="label">Status</label>
        <div class="flex items-center gap-3">
          <span id="statusSwitch" class="switch <%= product && product.is_active ? 'on' : '' %>"><i></i></span>
          <label class="inline-flex items-center gap-2">
            <input id="activeCheckbox" type="checkbox" name="is_active" value="1" class="hidden" <%= product && product.is_active ? 'checked' : '' %>>
            <span class="text-slate-700"><%= product && product.is_active ? 'Aktif' : 'Nonaktif' %></span>
          </label>
        </div>
        <p class="hint">Aktifkan jika produk siap ditampilkan.</p>
      </div>
    </div>

    <!-- Actions -->
    <div class="pt-2 flex flex-wrap gap-3">
      <button class="btn btn-primary">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
        Simpan
      </button>
      <a href="/admin/produk" class="btn btn-ghost">Batal</a>
      <% if (isEdit) { %>
        <a href="/admin/produk/edit/0" class="btn btn-ghost">Tambah Produk Baru</a>
      <% } %>
    </div>
  </form>
</div>


<script>
  // Live preview harga (format rupiah)
  (function(){
    const ipt = document.getElementById('priceInput');
    const out = document.getElementById('pricePretty');
    const fmt = new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', minimumFractionDigits:0 });
    const upd = ()=> out.textContent = fmt.format(Number(ipt.value||0));
    ipt?.addEventListener('input', upd); upd();
  })();

  // Switch status sinkron dengan checkbox
  (function(){
    const sw = document.getElementById('statusSwitch');
    const cb = document.getElementById('activeCheckbox');
    const label = sw?.parentElement?.querySelector('span.text-slate-700');

    function syncUI(){
      sw.classList.toggle('on', cb.checked);
      if(label) label.textContent = cb.checked ? 'Aktif' : 'Nonaktif';
    }
    sw?.addEventListener('click', ()=>{ cb.checked = !cb.checked; syncUI(); });
    cb?.addEventListener('change', syncUI);
    syncUI();
  })();
</script>

<%- include('../partials/admin-footer') %>
