<%- include('../../partials/admin-header', { title }) %>

<style>
  /* Slider bergradasi */
  #rateSlider{
    -webkit-appearance: none; height: 10px; border-radius: 9999px; width:100%;
    background: linear-gradient(90deg,#10b981 0%, #f59e0b 50%, #ef4444 100%);
  }
  #rateSlider::-webkit-slider-thumb{
    -webkit-appearance:none; width:18px; height:18px; border-radius:50%;
    background:#fff; border:2px solid #6366f1; box-shadow:0 2px 10px rgba(99,102,241,.35);
  }
  #rateSlider::-moz-range-thumb{
    width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #6366f1;
  }
  /* Gauge gunakan --tone */
  #gauge{ background: conic-gradient(hsl(var(--tone)) 0deg 0deg, #e5e7eb 0deg 360deg); }
  #gaugeInner{ background:#fff; }
</style>

<div class="max-w-2xl mx-auto mt-8">
  <div class="mb-5 flex items-center gap-3">
    <a href="/admin/gestun" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m15 19-7-7 7-7"/></svg>
      Kembali
    </a>
    <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
      <%= item ? 'Edit Provider Gestun' : 'Tambah Provider Gestun' %>
    </h1>
  </div>

  <form id="gForm" method="POST" action="<%= item ? '/admin/gestun/edit/'+item.id : '/admin/gestun/new' %>" class="bg-white rounded-2xl shadow ring-1 ring-black/5 p-6 space-y-6">
    <div class="grid sm:grid-cols-5 gap-6">
      <!-- Fields -->
      <div class="sm:col-span-3 space-y-5">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Nama Provider</label>
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v.01M8 6v.01M16 6v.01M4 8h16M5 20h14a2 2 0 0 0 2-2V8H3v10a2 2 0 0 0 2 2z"/></svg>
            <input id="name" name="name" required value="<%= item?.name || '' %>"
                   class="w-full border rounded-xl pl-9 pr-3 py-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none"
                   placeholder="Kredivo / Akulaku / ...">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Rate Potongan (%)</label>
          <div class="relative">
            <input id="ratePct" type="number" step="0.01" name="rate_pct" required value="<%= item?.rate_pct ?? '' %>"
                   class="w-full border rounded-xl pl-3 pr-12 py-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none"
                   placeholder="cth: 2.50" inputmode="decimal" min="0" max="100">
            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 font-semibold">%</span>
          </div>
          <input id="rateSlider" type="range" min="0" max="15" step="0.05" class="w-full mt-3">
          <p class="text-xs text-slate-500 mt-1">2.50 berarti dipotong 2.5% dari nominal.</p>
        </div>
      </div>

      <!-- Gauge -->
      <div class="sm:col-span-2">
        <div class="rounded-2xl border bg-slate-50 p-5 h-full grid place-items-center">
          <div class="relative" style="--tone: 140 85% 45%">
            <div id="gauge" class="w-44 h-44 rounded-full"></div>
            <div id="gaugeInner" class="absolute inset-3 rounded-full grid place-items-center text-center">
              <div>
                <div class="text-xs text-slate-500">Rate</div>
                <div id="gaugeVal" class="text-3xl font-extrabold text-slate-900">0.00%</div>
                <div id="gaugeHint" class="text-[11px] text-slate-500 mt-1">Rendah</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Simulasi cepat -->
    <div class="rounded-xl border bg-slate-50 p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs text-slate-500">Simulasi cepat</div>
          <div class="text-sm text-slate-700">Nominal contoh: <span id="simNominal" class="font-semibold">Rp 1.000.000</span></div>
        </div>
        <div class="flex items-center gap-2">
          <button type="button" data-n="500000"  class="simBtn px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">500rb</button>
          <button type="button" data-n="1000000" class="simBtn px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">1jt</button>
          <button type="button" data-n="2000000" class="simBtn px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">2jt</button>
        </div>
      </div>
      <div class="mt-3 grid sm:grid-cols-3 gap-3">
        <div class="p-3 rounded-lg bg-white border">
          <div class="text-xs text-slate-500">Potongan</div>
          <div id="simPotong" class="font-semibold text-rose-600">Rp 0</div>
        </div>
        <div class="p-3 rounded-lg bg-white border">
          <div class="text-xs text-slate-500">Diterima</div>
          <div id="simTerima" class="font-semibold text-emerald-700">Rp 0</div>
        </div>
        <div class="p-3 rounded-lg bg-white border">
          <div class="text-xs text-slate-500">Rate</div>
          <div id="simRate" class="font-semibold text-slate-800">0%</div>
        </div>
      </div>
    </div>

    <div class="pt-2 flex gap-2">
      <button id="saveBtn" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-indigo-600 to-fuchsia-600 text-white hover:brightness-110 disabled:opacity-50 disabled:pointer-events-none">Simpan</button>
      <a href="/admin/gestun" class="px-5 py-2.5 rounded-xl bg-white border hover:bg-slate-50">Batal</a>
    </div>
  </form>
</div>

<script>
(function(){
  const nf = new Intl.NumberFormat('id-ID');
  const toRp = n => 'Rp ' + nf.format(Math.max(0, Math.round(n||0)));

  const rateI = document.getElementById('ratePct');
  const slider = document.getElementById('rateSlider');
  const nameI = document.getElementById('name');
  const saveBtn = document.getElementById('saveBtn');

  const gauge     = document.getElementById('gauge').parentElement; // wrapper with --tone
  const gaugeVal  = document.getElementById('gaugeVal');
  const gaugeHint = document.getElementById('gaugeHint');

  let nominal = 1_000_000;
  const elNom  = document.getElementById('simNominal');
  const elPot  = document.getElementById('simPotong');
  const elTer  = document.getElementById('simTerima');
  const elRate = document.getElementById('simRate');

  function hueFromRate(r){
    const clamped = Math.max(0, Math.min(10, r));       // fokus 0–10%
    const t = 1 - (clamped / 10);                       // 0% hijau; 10% merah
    return 140 * t;                                     // 140≈emerald
  }

  function setGauge(r){
    const deg = Math.min(100, Math.max(0, r)) / 100 * 360;
    const hue = hueFromRate(r).toFixed(0);
    gauge.style.setProperty('--tone', `${hue} 85% 45%`);
    // update conic (pakai elemen #gauge di dalam)
    const ring = gauge.querySelector('#gauge');
    ring.style.background = `conic-gradient(hsl(${hue} 85% 45%) 0deg ${deg}deg, #e5e7eb ${deg}deg 360deg)`;
    gaugeVal.textContent = (isFinite(r)? r.toFixed(2) : '0.00') + '%';
    gaugeHint.textContent = r > 5 ? 'Tinggi' : r >= 2.5 ? 'Sedang' : 'Rendah';
  }

  function refreshSim(){
    const r = Number(rateI.value||0);
    const pot = nominal * (r/100);
    const ter = nominal - pot;
    elNom.textContent = toRp(nominal);
    elPot.textContent = toRp(pot);
    elTer.textContent = toRp(ter);
    elRate.textContent = (isFinite(r)? r.toFixed(2): '0.00') + '%';
    setGauge(r);
  }

  function syncFromInput(){
    let v = parseFloat(rateI.value);
    if(!isFinite(v)) v = 0;
    slider.value = Math.max(slider.min, Math.min(slider.max, v));
    refreshSim(); validate();
  }
  function syncFromSlider(){
    rateI.value = parseFloat(slider.value).toFixed(2);
    refreshSim(); validate();
  }

  document.querySelectorAll('.simBtn').forEach(b=>{
    b.addEventListener('click', ()=>{ nominal = Number(b.dataset.n||nominal); refreshSim(); });
  });

  function validate(){
    const ok = (nameI.value||'').trim().length > 0 && isFinite(parseFloat(rateI.value));
    saveBtn.disabled = !ok;
  }

  // init
  if(rateI.value==='' && slider){ rateI.value = '2.50'; slider.value = '2.50'; }
  syncFromInput(); validate();

  rateI.addEventListener('input', syncFromInput);
  slider.addEventListener('input', syncFromSlider);
  nameI.addEventListener('input', validate);
})();
</script>

<%- include('../../partials/admin-footer') %>
