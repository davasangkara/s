<%- include('../../partials/admin-header', { title }) %>

<style>
  #rateSlider{
    -webkit-appearance:none;height:10px;border-radius:9999px;width:100%;
    background:linear-gradient(90deg,#ef4444 0%,#f59e0b 50%,#10b981 100%);
  }
  #rateSlider::-webkit-slider-thumb{ -webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid #22c55e;box-shadow:0 2px 10px rgba(16,185,129,.35) }
  #rateSlider::-moz-range-thumb{ width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid #22c55e }
  #gauge{ background: conic-gradient(hsl(var(--tone)) 0deg 0deg, #e5e7eb 0deg 360deg); }
</style>

<div class="max-w-2xl mx-auto mt-8">
  <div class="mb-5 flex items-center gap-3">
    <a href="/admin/pulsa" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="m15 19-7-7 7-7"/></svg>
      Kembali
    </a>
    <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
      <%= item ? 'Edit Rate Pulsa' : 'Tambah Rate Pulsa' %>
    </h1>
  </div>

  <form id="pForm" method="POST" action="<%= item ? '/admin/pulsa/edit/'+item.id : '/admin/pulsa/new' %>" class="bg-white rounded-2xl shadow ring-1 ring-black/5 p-6 space-y-6">
    <div class="grid sm:grid-cols-5 gap-6">
      <div class="sm:col-span-3 space-y-5">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Provider</label>
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7h16M4 12h16M4 17h16"/></svg>
            <input id="prov" name="provider" required value="<%= item?.provider || '' %>" class="w-full border rounded-xl pl-9 pr-3 py-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none" placeholder="Telkomsel / Indosat / XL / â€¦">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Rate Diterima (%)</label>
          <div class="relative">
            <input id="rate" type="number" step="0.01" min="0" max="100" name="rate_pct" required value="<%= item?.rate_pct ?? '' %>" class="w-full border rounded-xl pl-3 pr-12 py-2 focus:ring-2 focus:ring-indigo-400 focus:outline-none" placeholder="cth: 82.5">
            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 font-semibold">%</span>
          </div>
          <input id="rateSlider" type="range" min="60" max="100" step="0.1" class="w-full mt-3">
          <p class="text-xs text-slate-500 mt-1">82.5 berarti dana diterima = 82.5% dari nominal pulsa.</p>
        </div>
      </div>

      <!-- Gauge -->
      <div class="sm:col-span-2">
        <div class="rounded-2xl border bg-slate-50 p-5 h-full grid place-items-center">
          <div class="relative" id="gWrap" style="--tone: 140 85% 45%">
            <div id="gauge" class="w-44 h-44 rounded-full"></div>
            <div class="absolute inset-3 rounded-full grid place-items-center text-center bg-white">
              <div>
                <div class="text-xs text-slate-500">Diterima</div>
                <div id="gVal" class="text-3xl font-extrabold text-slate-900">0.00%</div>
                <div id="gHint" class="text-[11px] text-slate-500 mt-1">Rendah</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Simulasi cepat -->
    <div class="rounded-xl border bg-slate-50 p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs text-slate-500">Simulasi cepat</div>
          <div class="text-sm text-slate-700">Nominal contoh: <span id="sNom" class="font-semibold">Rp 100.000</span></div>
        </div>
        <div class="flex items-center gap-2">
          <button type="button" data-n="100000" class="sBtn px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">100k</button>
          <button type="button" data-n="200000" class="sBtn px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">200k</button>
          <button type="button" data-n="500000" class="sBtn px-3 py-1.5 rounded-lg bg-white border hover:bg-slate-50">500k</button>
        </div>
      </div>
      <div class="mt-3 grid sm:grid-cols-3 gap-3">
        <div class="p-3 rounded-lg bg-white border">
          <div class="text-xs text-slate-500">Diterima</div>
          <div id="sTerima" class="font-semibold text-emerald-700">Rp 0</div>
        </div>
        <div class="p-3 rounded-lg bg-white border">
          <div class="text-xs text-slate-500">Potongan</div>
          <div id="sPotong" class="font-semibold text-rose-600">Rp 0</div>
        </div>
        <div class="p-3 rounded-lg bg-white border">
          <div class="text-xs text-slate-500">Rate</div>
          <div id="sRate" class="font-semibold text-slate-800">0%</div>
        </div>
      </div>
    </div>

    <div class="pt-2 flex gap-2">
      <button id="saveBtn" class="px-5 py-2.5 rounded-xl bg-gradient-to-r from-indigo-600 to-fuchsia-600 text-white hover:brightness-110 disabled:opacity-50 disabled:pointer-events-none">Simpan</button>
      <a href="/admin/pulsa" class="px-5 py-2.5 rounded-xl bg-white border hover:bg-slate-50">Batal</a>
    </div>
  </form>
</div>

<script>
(function(){
  const nf = new Intl.NumberFormat('id-ID');
  const toRp = n => 'Rp ' + nf.format(Math.max(0, Math.round(n||0)));

  const prov = document.getElementById('prov');
  const rate = document.getElementById('rate');
  const slider = document.getElementById('rateSlider');
  const saveBtn = document.getElementById('saveBtn');

  const wrap = document.getElementById('gWrap');
  const gVal = document.getElementById('gVal');
  const gHint= document.getElementById('gHint');
  const gRing= document.getElementById('gauge');

  let nominal = 100000;
  const sNom = document.getElementById('sNom');
  const sTer = document.getElementById('sTerima');
  const sPot = document.getElementById('sPotong');
  const sRate= document.getElementById('sRate');

  function hueFromAccept(p){
    const v = Math.max(60, Math.min(95, p));
    const t = (v - 60) / (95 - 60);
    return 0 + (140 * t);
  }
  function setGauge(p){
    const deg = Math.min(100, Math.max(0, p))/100*360;
    const hue = hueFromAccept(p).toFixed(0);
    wrap.style.setProperty('--tone', `${hue} 85% 45%`);
    gRing.style.background = `conic-gradient(hsl(${hue} 85% 45%) 0deg ${deg}deg, #e5e7eb ${deg}deg 360deg)`;
    gVal.textContent = (isFinite(p)? p.toFixed(2):'0.00') + '%';
    gHint.textContent = p > 85 ? 'Bagus' : p >= 70 ? 'Cukup' : 'Rendah';
  }
  function refreshSim(){
    const r = Number(rate.value||0);
    const ter = nominal * (r/100);
    const pot = nominal - ter;
    sNom.textContent = toRp(nominal);
    sTer.textContent = toRp(ter);
    sPot.textContent = toRp(pot);
    sRate.textContent= (isFinite(r)? r.toFixed(2):'0.00') + '%';
    setGauge(r); validate();
  }
  function syncFromInput(){
    let v = parseFloat(rate.value);
    if(!isFinite(v)) v = 0;
    slider.value = Math.max(slider.min, Math.min(slider.max, v));
    refreshSim();
  }
  function syncFromSlider(){
    rate.value = parseFloat(slider.value).toFixed(2);
    refreshSim();
  }
  document.querySelectorAll('.sBtn').forEach(b=>b.addEventListener('click',()=>{ nominal = Number(b.dataset.n||nominal); refreshSim(); }));
  function validate(){
    saveBtn.disabled = !((prov.value||'').trim().length && isFinite(parseFloat(rate.value)));
  }

  if(rate.value===''){ rate.value='82.50'; slider.value='82.5'; }
  syncFromInput(); validate();

  prov.addEventListener('input', validate);
  rate.addEventListener('input', syncFromInput);
  slider.addEventListener('input', syncFromSlider);
})();
</script>

<%- include('../../partials/admin-footer') %>
