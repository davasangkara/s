<%- include('../partials/admin-header') %>

<%
  const cats = (categories || []).map(c => ({
    ...c,
    total_produk: Number(c.total_produk || 0),
    total_harga: Number(c.total_harga || 0),
    rata_rate: Number(c.rata_rate || 0)
  }));
  const sumProduk = cats.reduce((a,c)=>a+c.total_produk,0);
  const sumHarga  = cats.reduce((a,c)=>a+c.total_harga,0);
  const avgRate   = cats.length ? (cats.reduce((a,c)=>a+c.rata_rate,0)/cats.length) : 0;
  const toIDR = n => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n||0);
%>

<style>
  .soft-card{background:#fff;border-radius:1.25rem;box-shadow:0 16px 40px rgba(0,0,0,.06);border:1px solid #e5e7eb}
  .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.75rem;padding:.55rem .95rem;transition:.2s}
  .btn-primary{background:#2563eb;color:#fff}.btn-primary:hover{background:#1d4ed8}
  .btn-ghost{background:#fff;border:1px solid #e5e7eb}.btn-ghost:hover{background:#f9fafb}
  .thead-sticky th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #e5e7eb;z-index:1}
  .row-hover:hover td{background:#f9fbff}
  .chip{font-size:.75rem;padding:.2rem .5rem;border-radius:.5rem;font-weight:600}
</style>

<!-- HERO -->
<section class="rounded-3xl p-6 md:p-8 mb-8 relative overflow-hidden" style="background:
  radial-gradient(900px 320px at -10% -10%, rgba(255,255,255,.25), transparent),
  radial-gradient(900px 320px at 110% 120%, rgba(255,255,255,.18), transparent),
  linear-gradient(135deg, #2563EB 0%, #4F46E5 55%, #DB2777 100%);">
  <div class="absolute -right-20 -top-24 w-[420px] h-[420px] rounded-full bg-white/10 blur-3xl"></div>
  <div class="relative z-10 flex flex-col md:flex-row md:items-end md:justify-between gap-6 text-white">
    <div>
      <p class="text-white/90 text-sm mb-1">Kelola kategori & ringkasan produk</p>
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Daftar Kategori</h1>
      <p class="mt-1 text-white/95"><strong><%= cats.length %></strong> kategori • <strong><%= sumProduk %></strong> produk</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="/admin/kategori/tambah" class="btn btn-primary">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14"/></svg>
        Tambah Kategori
      </a>
    </div>
  </div>
</section>

<div class="max-w-7xl mx-auto">
  <!-- ACTION BAR -->
  <div class="soft-card p-4 md:p-5 mb-5">
    <div class="flex flex-col md:flex-row md:items-center gap-3 justify-between">
      <div class="flex items-center gap-2">
        <div class="hidden md:block text-sm font-medium text-slate-600">
          <span class="inline-flex items-center gap-1">
            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.3-4.3"/></svg>
            Filter cepat
          </span>
        </div>
      </div>
      <div class="flex flex-1 md:flex-none items-center gap-3">
        <!-- Search -->
        <div class="relative flex-1">
          <svg class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="m21 21-4.3-4.3"/></svg>
          <input id="tableSearch" type="text" placeholder="Cari nama/slug..."
                 class="w-full md:w-72 border border-slate-300 rounded-lg pl-9 pr-3 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none">
        </div>
        <!-- Produk filter -->
        <div>
          <select id="prodFilter" class="border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none">
            <option value="">Semua</option>
            <option value="ada">Ada Produk</option>
            <option value="kosong">Kosong</option>
          </select>
        </div>
        <!-- Quick add (opsional, route: /admin/kategori/quick) -->
        <form action="/admin/kategori/quick" method="POST" class="hidden md:flex items-center gap-2">
          <input name="name" placeholder="Tambah cepat..." class="border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400 focus:outline-none">
          <button class="btn btn-ghost">Tambah</button>
        </form>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="soft-card overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="thead-sticky text-slate-700">
          <tr>
            <th class="p-3 text-left w-16 bg-slate-50">#</th>
            <th class="p-3 text-left bg-slate-50">Nama</th>
            <th class="p-3 text-left bg-slate-50">Slug</th>
            <th class="p-3 text-center bg-slate-50">Total Produk</th>
            <th class="p-3 text-right bg-slate-50">Total Harga</th>
            <th class="p-3 text-right bg-slate-50">Rata Rate</th>
            <th class="p-3 text-right bg-slate-50">Aksi</th>
          </tr>
        </thead>
        <tbody id="catTbody" class="divide-y">
          <% cats.forEach((cat, idx) => { %>
            <tr class="row-hover"
                data-name="<%= (cat.name||'').toLowerCase() %>"
                data-slug="<%= (cat.slug||'').toLowerCase() %>"
                data-hasprod="<%= cat.total_produk > 0 ? '1' : '0' %>">
              <td class="p-3 text-slate-500"><%= idx+1 %></td>
              <td class="p-3 font-medium text-slate-900"><%= cat.name %></td>
              <td class="p-3 text-slate-700"><%= cat.slug %></td>
              <td class="p-3 text-center">
                <% if (cat.total_produk > 0) { %>
                  <span class="chip bg-green-50 text-green-700 border border-green-200"><%= cat.total_produk %></span>
                <% } else { %>
                  <span class="chip bg-slate-100 text-slate-600 border border-slate-300">0</span>
                <% } %>
              </td>
              <td class="p-3 text-right tabular-nums"><%= toIDR(cat.total_harga) %></td>
              <td class="p-3 text-right"><%= (Math.round(cat.rata_rate*100)/100).toFixed(2) %> %</td>
              <td class="p-3">
                <div class="flex items-center justify-end gap-2">
                  <a href="/admin/kategori/edit/<%= cat.id %>" class="btn btn-ghost" title="Edit">
                    <svg class="w-4 h-4 text-slate-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5h2m-1 14v-4m5.5-8.5L20 7l-9 9-4 1 1-4 9-9z"/>
                    </svg>
                    Edit
                  </a>
                  <!-- Disarankan pakai POST delete -->
                  <form action="/admin/kategori/delete/<%= cat.id %>" method="POST" onsubmit="return confirm('Yakin ingin hapus kategori ini?')">
                    <button class="btn" style="background:#ef4444;color:#fff" title="Hapus">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-1-3H10a2 2 0 0 0-2 2v1h8V6a2 2 0 0 0-2-2z"/>
                      </svg>
                      Hapus
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          <% }) %>

          <% if (cats.length === 0) { %>
            <tr>
              <td colspan="7" class="px-6 py-12 text-center">
                <div class="mx-auto w-24 h-24 rounded-full bg-blue-50 border border-blue-100 grid place-items-center mb-3">
                  <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h4l2 2h12v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/>
                  </svg>
                </div>
                <div class="text-slate-700 font-medium">Belum ada kategori</div>
                <p class="text-slate-500 text-sm">Mulai dengan menambahkan kategori baru.</p>
                <a href="/admin/kategori/tambah" class="mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14M5 12h14"/></svg>
                  Tambah Kategori
                </a>
              </td>
            </tr>
          <% } %>

          <!-- No result after filter -->
          <tr id="noResultRow" class="hidden">
            <td colspan="7" class="px-6 py-10 text-center text-slate-500">
              Tidak ada hasil untuk filter saat ini.
            </td>
          </tr>
        </tbody>

        <!-- FOOT SUMMARY -->
        <% if (cats.length) { %>
        <tfoot class="bg-slate-50">
          <tr class="font-semibold text-slate-800">
            <td class="p-3">—</td>
            <td class="p-3">Total</td>
            <td class="p-3">—</td>
            <td class="p-3 text-center"><%= sumProduk %></td>
            <td class="p-3 text-right"><%= toIDR(sumHarga) %></td>
            <td class="p-3 text-right"><%= (Math.round(avgRate*100)/100).toFixed(2) %> %</td>
            <td class="p-3"></td>
          </tr>
        </tfoot>
        <% } %>
      </table>
    </div>
  </div>
</div>

<script>
  // Client-side search + produk filter
  (function(){
    const q = document.getElementById('tableSearch');
    const pf = document.getElementById('prodFilter');
    const tbody = document.getElementById('catTbody');
    const rows = Array.from(tbody.querySelectorAll('tr.row-hover'));
    const noResult = document.getElementById('noResultRow');

    function apply(){
      const term = (q?.value || '').trim().toLowerCase();
      const pval = (pf?.value || '');

      let visible = 0;
      rows.forEach(tr=>{
        const name = tr.dataset.name || '';
        const slug = tr.dataset.slug || '';
        const has = tr.dataset.hasprod === '1';

        const hitTerm = term ? (name.includes(term) || slug.includes(term)) : true;
        const hitProd = pval === '' ? true : (pval==='ada' ? has : !has);

        const show = hitTerm && hitProd;
        tr.style.display = show ? '' : 'none';
        if (show) visible++;
      });

      if (noResult) noResult.classList.toggle('hidden', visible !== 0);
    }

    q?.addEventListener('input', apply);
    pf?.addEventListener('change', apply);
  })();
</script>

<%- include('../partials/admin-footer') %>
