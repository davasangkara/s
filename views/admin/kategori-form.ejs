<%- include('../partials/admin-header') %>

<%
  const isEdit = !!(category && category.id);
  const formAction = isEdit ? `/admin/kategori/edit/${category.id}` : '/admin/kategori/tambah';
  const nameVal = isEdit ? category.name : '';
  const slugVal = isEdit ? category.slug : '';
%>

<style>
  :root{
    --line:#e5e7eb; --shadow:0 12px 36px rgba(2,6,23,.06); --primary:#2563eb;
  }
  .soft-card{background:#fff;border-radius:1.25rem;box-shadow:var(--shadow);border:1px solid var(--line)}
  .btn{display:inline-flex;align-items:center;gap:.5rem;border-radius:.75rem;padding:.6rem 1rem;transition:.2s}
  .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:#1d4ed8}
  .btn-ghost{background:#fff;border:1px solid var(--line)}.btn-ghost:hover{background:#f9fafb}
  .label{display:flex;align-items:center;gap:.5rem;font-size:.9rem;font-weight:600;color:#334155;margin-bottom:.35rem}
  .hint{font-size:.8rem;color:#64748b;margin-top:.35rem}
  .ipt{width:100%;border:1px solid var(--line);border-radius:.75rem;padding:.65rem .9rem;outline:0}
  .ipt:focus{box-shadow:0 0 0 3px rgba(37,99,235,.15);border-color:#bfdbfe}
  .slug-wrap{position:relative}
  .slug-prefix{position:absolute;left:.9rem;top:50%;transform:translateY(-50%);color:#64748b;font-size:.9rem}
  .slug-input{padding-left:7.2rem} /* lebar '/kategori/' */
  .switch{display:inline-flex;align-items:center;gap:.5rem;font-size:.85rem}
  .switch input{accent-color:#2563eb}
</style>

<!-- HERO MINI -->
<section class="rounded-3xl p-6 md:p-8 mb-8 relative overflow-hidden" style="background:
  radial-gradient(900px 320px at -10% -10%, rgba(255,255,255,.25), transparent),
  radial-gradient(900px 320px at 110% 120%, rgba(255,255,255,.18), transparent),
  linear-gradient(135deg, #2563EB 0%, #4F46E5 55%, #DB2777 100%);">
  <div class="absolute -right-20 -top-24 w-[420px] h-[420px] rounded-full bg-white/10 blur-3xl"></div>
  <div class="relative z-10 flex items-center justify-between gap-6 text-white">
    <div>
      <p class="text-white/90 text-sm mb-1">Kelola nama & slug kategori</p>
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight"><%= isEdit ? 'Edit Kategori' : 'Tambah Kategori' %></h1>
    </div>
    <div class="flex gap-2">
      <a href="/admin/kategori" class="btn btn-ghost text-white border-white/60">Kembali</a>
    </div>
  </div>
</section>

<div class="max-w-3xl mx-auto">
  <form method="POST" action="<%= formAction %>" class="soft-card p-6 md:p-8 space-y-7">
    <!-- Nama -->
    <div>
      <label class="label">Nama Kategori</label>
      <input id="nameInput" type="text" name="name" required value="<%= nameVal %>" class="ipt" placeholder="Contoh: Pulsa Telkomsel">
      <p class="hint">Gunakan nama yang singkat & jelas.</p>
    </div>

    <!-- Slug -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">Slug</label>
        <label class="switch"><input type="checkbox" id="manualToggle"> Atur slug manual</label>
      </div>
      <div class="slug-wrap">
        <span class="slug-prefix">/kategori/</span>
        <input id="slugInput" type="text" name="slug" required value="<%= slugVal %>"
              class="ipt slug-input" placeholder="pulsa-telkomsel" <%= isEdit ? '' : 'disabled' %>>
      </div>
      <p class="hint">Slug adalah bagian URL. Contoh: <code>/kategori/pulsa-telkomsel</code></p>
    </div>

    <!-- Actions -->
    <div class="pt-1 flex flex-wrap gap-3">
      <button type="submit" class="btn btn-primary">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
        Simpan
      </button>
      <a href="/admin/kategori" class="btn btn-ghost">Batal</a>
      <% if (isEdit) { %>
        <a href="/admin/kategori/tambah" class="btn btn-ghost">Tambah Baru</a>
      <% } %>
    </div>
  </form>
</div>

<script>
  // Slugify utility
  function slugify(str){
    return String(str || '')
      .normalize('NFKD')                // handle accents
      .replace(/[\u0300-\u036f]/g, '') // strip diacritics
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '')    // keep alnum & space/hyphen
      .trim()
      .replace(/\s+/g, '-')            // spaces -> dash
      .replace(/-+/g, '-');            // collapse dashes
  }

  (function(){
    const nameI = document.getElementById('nameInput');
    const slugI = document.getElementById('slugInput');
    const toggle = document.getElementById('manualToggle');

    // Default: saat tambah baru, auto-generate dan kunci input
    let manual = <%- JSON.stringify(isEdit) %>; // edit: default manual=false (biar tidak sembarang), tapi izinkan toggle
    if (!<%- JSON.stringify(isEdit) %>) {
      manual = false;
      slugI.disabled = true;
      // generate awal dari value name jika ada
      if (nameI.value) slugI.value = slugify(nameI.value);
    }

    toggle.checked = manual;
    toggle.addEventListener('change', () => {
      manual = toggle.checked;
      slugI.disabled = !manual;
      if (!manual) {
        // kunci lagi: sinkron dari nama
        slugI.value = slugify(nameI.value);
      }
    });

    // Saat mengetik nama & mode otomatis -> update slug
    let t;
    nameI.addEventListener('input', () => {
      if (manual) return;
      clearTimeout(t);
      t = setTimeout(()=>{ slugI.value = slugify(nameI.value); }, 120);
    });

    // Saat user mengetik slug manual -> bersihkan format
    slugI.addEventListener('input', () => {
      if (!manual) return;
      const pos = slugI.selectionStart;
      slugI.value = slugify(slugI.value);
      // optional: pertahankan approx caret
      try { slugI.setSelectionRange(pos, pos); } catch(e){}
    });
  })();
</script>

<%- include('../partials/admin-footer') %>
